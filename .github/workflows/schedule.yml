name: Daily Podcast Automation - The Unfiltered Record

on:
  # CRON Schedule: Runs every day at 06:00 AM UTC 
  # Adjust '0 6 * * *' to your preferred time (e.g., '0 10 * * *' for 5 AM EST)
  schedule:
    - cron: '0 6 * * *' 
  # Allows manual triggering directly from the 'Actions' tab for testing
  workflow_dispatch: 

jobs:
  run_podcast_job: 
    runs-on: ubuntu-latest
    
    # üö® CRITICAL: Permissions block is required for Workload Identity Federation (WIF)
    permissions:
      id-token: write  # Enables the GitHub OIDC token generation
      contents: read   # Allows the action to check out the code

    steps:
    
    # 1. Setup & Dependencies
    - name: Checkout repository code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install FFMPEG (required by pydub for audio processing)
      run: sudo apt-get update && sudo apt-get install -y ffmpeg
        
    - name: 'Install Python dependencies'
      run: pip install -r requirements.txt
      
    # 2. Secure Authentication (WIF for GCP TTS)
    - name: 'Authenticate to Google Cloud via WIF'
      uses: 'google-github-actions/auth@v3'
      with:
        # ‚ö†Ô∏è REPLACE with your Service Account Email
        service_account: 'gcp-tts@fluted-volt-477708-r8.iam.gserviceaccount.com '
        # ‚ö†Ô∏è REPLACE with your full WIF Provider ID
        workload_identity_provider: 'projects/fluted-volt-477708-r8/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider'

    # 3. Execution
    - name: 'Run Scraper and Generate Audio'
      # The WIF credentials are automatically available here.
      run: python main_scraper.py
      env:
        # üîë Must store these in GitHub Secrets 
        CONGRESS_KEY: ${{ secrets.CONGRESS_API_KEY }} 
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
